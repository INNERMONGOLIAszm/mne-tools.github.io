<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The Cookbook &mdash; MNE 0.9.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/navy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MNE 0.9.0 documentation" href="../index.html" />
    <link rel="up" title="Manual" href="../manual.html" />
    <link rel="next" title="Processing raw data" href="browse.html" />
    <link rel="prev" title="Overview" href="list.html" />

<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700' rel='stylesheet' type='text/css'>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37225609-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>



    <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);
    js.id=id;js.src="http://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>



    <script type="text/javascript">
    (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    </script>


  </head>
  <body role="document">

<div style="background-color: white; text-align: left; padding: 10px 7px 15px 15px; min-width: 910px">
<div style="float: left">
<a href="../index.html"><img src="../_static/mne_logo.png" border="0" alt="py4sci"/></a>
</div>

<div style="float: right">
<a href="../index.html"><img src="../_static/institutions.png" border="0" alt="py4sci"/></a>
</div>
<br style="clear:both"/>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="right" >
          <a href="browse.html" title="Processing raw data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="list.html" title="Overview"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Home</a>&nbsp;|&nbsp;</li>
        <li><a href="../manual.html">Manual</a>&nbsp;|&nbsp;</li>
        <li><a href="../mne-python.html">Python</a>&nbsp;|&nbsp;</li>
        <li><a href="../cite.html">Cite MNE</a>&nbsp;|&nbsp;</li>
        <!-- <li><a href="../search.html">Search</a></li> -->

          <li class="nav-item nav-item-1"><a href="../manual.html" accesskey="U">Manual</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../manual.html">Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="list.html">Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">The Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="browse.html">Processing raw data</a></li>
<li class="toctree-l2"><a class="reference internal" href="forward.html">The forward solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="mne.html">The current estimates</a></li>
<li class="toctree-l2"><a class="reference internal" href="analyze.html">Interactive analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="morph.html">Morphing and averaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="convert.html">Data conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="matlab.html">The Matlab toolbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="utilities.html">Miscellaneous utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="sampledata.html">The sample data set</a></li>
<li class="toctree-l2"><a class="reference internal" href="reading.html">Related publications</a></li>
<li class="toctree-l2"><a class="reference internal" href="AppA.html">Creating the BEM meshes</a></li>
<li class="toctree-l2"><a class="reference internal" href="AppB.html">Setup at the Martinos Center</a></li>
<li class="toctree-l2"><a class="reference internal" href="AppInstall.html">Installation and configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="AppReleaseNotes.html">Release notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="AppEULA.html">Licence agreement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_tutorial.html">Getting started with MNE command line</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mne-python.html">MNE with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mne-cpp.html">MNE with CPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cite.html">Cite MNE and MNE-Python</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Versions</h3>
<ul class="current">
    <li class="toctree-l1"><a href=http://martinos.org/mne/stable>Stable</a></li>
    <li class="toctree-l1"><a href=http://martinos.org/mne/dev>Development</a></li>
</ul>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-cookbook">
<span id="ch-cookbook"></span><h1>The Cookbook<a class="headerlink" href="#the-cookbook" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This section describes the typical workflow needed to produce
the minimum-norm estimate movies using the MNE software. The workflow
is summarized in <a class="reference internal" href="#cihbiiah"><span>Workflow of the MNE software</span></a>.</p>
<div class="figure align-center" id="id1">
<span id="cihbiiah"></span><img alt="MNE Workflow Flowchart" src="../_images/Flowchart.png" />
<p class="caption"><span class="caption-text">Workflow of the MNE software</span></p>
<div class="legend">
References in parenthesis indicate sections and chapters of this manual.</div>
</div>
</div>
<div class="section" id="selecting-the-subject">
<h2>Selecting the subject<a class="headerlink" href="#selecting-the-subject" title="Permalink to this headline">¶</a></h2>
<p>Before starting the data analysis, setup the environment
variable SUBJECTS_DIR to select the directory under which the anatomical
MRI data are stored. Optionally, set SUBJECT as the name of the
subject&#8217;s MRI data directory under SUBJECTS_DIR. With this
setting you can avoid entering the <code class="docutils literal"><span class="pre">--subject</span></code> option common to many
MNE programs and scripts. In the following sections, files in the
FreeSurfer directory hierarchy are usually referred to without specifying
the leading directories. Thus, bem/msh-7-src.fif is used to refer
to the file $SUBJECTS_DIR/$SUBJECT/bem/msh-7-src.fif.</p>
<p>It is also recommended that the FreeSurfer environment
is set up before using the MNE software.</p>
</div>
<div class="section" id="cortical-surface-reconstruction-with-freesurfer">
<span id="chdbbcej"></span><h2>Cortical surface reconstruction with FreeSurfer<a class="headerlink" href="#cortical-surface-reconstruction-with-freesurfer" title="Permalink to this headline">¶</a></h2>
<p>The first processing stage is the creation of various surface
reconstructions with FreeSurfer .
The recommended FreeSurfer workflow
is summarized on the FreeSurfer wiki pages: <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/RecommendedReconstruction">https://surfer.nmr.mgh.harvard.edu/fswiki/RecommendedReconstruction</a>.
Please refer to the FreeSurfer wiki pages
(<a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/">https://surfer.nmr.mgh.harvard.edu/fswiki/</a>) and other FreeSurfer documentation
for more information.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Only the latest (4.0.X and later) FreeSurfer distributions    contain a version of tkmedit which    is compatible with mne_analyze, see <a class="reference internal" href="analyze.html#cacchcbf"><span>Working with the MRI viewer</span></a>.</p>
</div>
</div>
<div class="section" id="setting-up-the-anatomical-mr-images-for-mrilab">
<span id="babccehf"></span><h2>Setting up the anatomical MR images for MRIlab<a class="headerlink" href="#setting-up-the-anatomical-mr-images-for-mrilab" title="Permalink to this headline">¶</a></h2>
<p>If you have the Neuromag software installed, the Neuromag
MRI viewer, MRIlab, can be used to access the MRI slice data created
by FreeSurfer . In addition, the
Neuromag MRI directories can be used for storing the MEG/MRI coordinate
transformations created with mne_analyze ,
see <a class="reference internal" href="analyze.html#cacehgcd"><span>Coordinate frame alignment</span></a>.  During the computation of the forward
solution, mne_do_forwand_solution searches
for the MEG/MRI coordinate in the Neuromag MRI directories, see <a class="reference internal" href="#babchejd"><span>Computing the forward solution</span></a>. The fif files created by mne_setup_mrit can
be loaded into Matlab with the fiff_read_mri function,
see <a class="reference internal" href="matlab.html#ch-matlab"><span>The Matlab toolbox</span></a>.</p>
<p>These functions require running the script mne_setup_mri which
requires that the subject is set with the <code class="docutils literal"><span class="pre">--subject</span></code> option
or by the SUBJECT environment variable. The script processes one
or more MRI data sets from <code class="docutils literal"><span class="pre">$SUBJECTS_DIR/$SUBJECT/mri</span></code> ,
by default they are T1 and brain. This default can be changed by
specifying the sets by one or more <code class="docutils literal"><span class="pre">--mri</span></code> options.</p>
<p>The script creates the directories <code class="docutils literal"><span class="pre">mri/</span></code> &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-neuromag/slices</span></code> and <code class="docutils literal"><span class="pre">mri/</span></code> &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-neuromag/sets</span></code> .
If the input data set is in COR format, mne_setup_mri makes
symbolic links from the COR files in the directory <code class="docutils literal"><span class="pre">mri/</span></code> &lt;<em>name</em>&gt; into <code class="docutils literal"><span class="pre">mri/</span></code> &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-neuromag/slices</span></code> ,
and creates a corresponding fif file COR.fif in <code class="docutils literal"><span class="pre">mri/</span></code> &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-neuromag/sets</span></code> ..
This &#8220;description file&#8221; contains references to
the actual MRI slices.</p>
<p>If the input MRI data are stored in the newer mgz format,
the file created in the <code class="docutils literal"><span class="pre">mri/</span></code> &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-neuromag/sets</span></code> directory
will include the MRI pixel data as well. If available, the coordinate
transformations to allow conversion between the MRI (surface RAS)
coordinates and MNI and FreeSurfer Talairach coordinates are copied
to the MRI description file. mne_setup_mri invokes mne_make_cor_set ,
described in <a class="reference internal" href="convert.html#babbhhhe"><span>Converting MRI data into the fif format</span></a> to convert the data.</p>
<p>For example:</p>
<p><code class="docutils literal"><span class="pre">mne_setup_mri</span> <span class="pre">--subject</span> <span class="pre">duck_donald</span> <span class="pre">--mri</span> <span class="pre">T1</span></code></p>
<p>This command processes the MRI data set T1 for subject duck_donald.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the SUBJECT environment variable is set it    is usually sufficient to run mne_setup_mri without    any options.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the name specified with the <code class="docutils literal"><span class="pre">--mri</span></code> option    contains a slash, the MRI data are accessed from the directory specified    and the <code class="docutils literal"><span class="pre">SUBJECT</span></code> and <code class="docutils literal"><span class="pre">SUBJECTS_DIR</span></code> environment    variables as well as the <code class="docutils literal"><span class="pre">--subject</span></code> option are ignored.</p>
</div>
</div>
<div class="section" id="setting-up-the-source-space">
<span id="cihchdae"></span><h2>Setting up the source space<a class="headerlink" href="#setting-up-the-source-space" title="Permalink to this headline">¶</a></h2>
<p>This stage consists of the following:</p>
<ul class="simple">
<li>Creating a suitable decimated dipole
grid on the white matter surface.</li>
<li>Creating the source space file in fif format.</li>
<li>Creating ascii versions of the source space file for viewing
with MRIlab.</li>
</ul>
<p>All of the above is accomplished with the convenience script mne_setup_source_space . This
script assumes that:</p>
<ul class="simple">
<li>The anatomical MRI processing has been
completed as described in <a class="reference internal" href="#chdbbcej"><span>Cortical surface reconstruction with FreeSurfer</span></a>.</li>
<li>The environment variable SUBJECTS_DIR is set correctly.</li>
</ul>
<p>The script accepts the following options:</p>
<p><strong>&#8212;subject &lt;*subject*&gt;</strong></p>
<blockquote>
<div>Defines the name of the subject. If the environment variable SUBJECT
is set correctly, this option is not required.</div></blockquote>
<p><strong>&#8212;morph &lt;*name*&gt;</strong></p>
<blockquote>
<div>Name of a subject in SUBJECTS_DIR. If this option is present, the source
space will be first constructed for the subject defined by the &#8211;subject
option or the SUBJECT environment variable and then morphed to this
subject. This option is useful if you want to create a source spaces
for several subjects and want to directly compare the data across
subjects at the source space vertices without any morphing procedure
afterwards. The drawback of this approach is that the spacing between
source locations in the &#8220;morph&#8221; subject is not going
to be as uniform as it would be without morphing.</div></blockquote>
<p><strong>&#8212;spacing &lt;*spacing/mm*&gt;</strong></p>
<blockquote>
<div>Specifies the grid spacing for the source space in mm. If not set,
a default spacing of 7 mm is used. Either the default or a 5-mm
spacing is recommended.</div></blockquote>
<p><strong>&#8212;ico &lt;*number*&gt;</strong></p>
<blockquote>
<div>Instead of using the traditional method for cortical surface decimation
it is possible to create the source space using the topology of
a recursively subdivided icosahedron (&lt;<em>number</em>&gt; &gt; 0)
or an octahedron (&lt;<em>number</em>&gt; &lt; 0).
This method uses the cortical surface inflated to a sphere as a
tool to find the appropriate vertices for the source space. The
benefit of the <code class="docutils literal"><span class="pre">--ico</span></code> option is that the source space
will have triangulation information for the decimated vertices included, which
future versions of MNE software may be able to utilize. The number
of triangles increases by a factor of four in each subdivision,
starting from 20 triangles in an icosahedron and 8 triangles in an
octahedron. Since the number of vertices on a closed surface is <span class="math">n_{vert} = (n_{tri} + 4)/2</span>,
the number of vertices in the <em>k</em> th subdivision of
an icosahedron and an octahedron are <span class="math">10 \cdot 4^k + 2</span> and <span class="math">4^{k + 1} + 2</span>, respectively.
The recommended values for &lt;<em>number</em>&gt; and
the corresponding number of source space locations are listed in <a class="reference internal" href="#babgcdha"><span>Recommended subdivisions of an icosahedron and an octahedron for the creation of source spaces. The approximate source spacing and corresponding surface area have been calculated assuming a 1000-cm2 surface area per hemisphere.</span></a>.</div></blockquote>
<p><strong>&#8212;surface &lt;*name*&gt;</strong></p>
<blockquote>
<div>Name of the surface under the surf directory to be used. Defaults
to &#8216;white&#8217;. <code class="docutils literal"><span class="pre">mne_setup_source_space</span></code> looks
for files <code class="docutils literal"><span class="pre">rh.</span></code> &lt;<em>name</em>&gt; and <code class="docutils literal"><span class="pre">lh.</span></code> &lt;<em>name</em>&gt; under
the <code class="docutils literal"><span class="pre">surf</span></code> directory.</div></blockquote>
<p><strong>&#8212;overwrite</strong></p>
<blockquote>
<div>An existing source space file with the same name is overwritten only
if this option is specified.</div></blockquote>
<p><strong>&#8212;cps</strong></p>
<blockquote>
<div>Compute the cortical patch statistics. This is need if current-density estimates
are computed, see <a class="reference internal" href="mne.html#cbbdbhdi"><span>Cortical patch statistics</span></a>. If the patch information is
available in the source space file the surface normal is considered to
be the average normal calculated over the patch instead of the normal
at each source space location. The calculation of this information
takes a considerable amount of time because of the large number
of Dijkstra searches involved.</div></blockquote>
<table border="1" class="docutils" id="id2">
<span id="babgcdha"></span><caption><span class="caption-text">Recommended subdivisions of an icosahedron and an octahedron for the creation of source spaces. The approximate source spacing and corresponding surface area have been calculated assuming a 1000-cm2 surface area per hemisphere.</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="12%" />
<col width="28%" />
<col width="24%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&lt;<em>number</em>&gt;</th>
<th class="head">Sources per hemisphere</th>
<th class="head">Source spacing / mm</th>
<th class="head">Surface area per source / mm2</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>-5</td>
<td>1026</td>
<td>9.9</td>
<td>97</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>2562</td>
<td>6.2</td>
<td>39</td>
</tr>
<tr class="row-even"><td>-6</td>
<td>4098</td>
<td>4.9</td>
<td>24</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>10242</td>
<td>3.1</td>
<td>9.8</td>
</tr>
</tbody>
</table>
<p>For example, to create the reconstruction geometry for Donald
Duck with a 5-mm spacing between the grid points, say</p>
<p><code class="docutils literal"><span class="pre">mne_setup_source_space</span> <span class="pre">--subject</span> <span class="pre">duck_donald</span> <span class="pre">--spacing</span> <span class="pre">5</span></code></p>
<p>As a result, the following files are created into the <code class="docutils literal"><span class="pre">bem</span></code> directory:</p>
<ul class="simple">
<li>&lt;<em>subject</em>&gt;-&lt;<em>spacing</em>&gt;- <code class="docutils literal"><span class="pre">src.fif</span></code> containing
the source space description in fif format.</li>
<li>&lt;<em>subject</em>&gt;-&lt;<em>spacing</em>&gt;- <code class="docutils literal"><span class="pre">lh.pnt</span></code> and &lt;<em>subject</em>&gt;-&lt;<em>spacing</em>&gt;- <code class="docutils literal"><span class="pre">rh.pnt</span></code> containing
the source space points in MRIlab compatible ascii format.</li>
<li>&lt;<em>subject</em>&gt;-&lt;<em>spacing</em>&gt;- <code class="docutils literal"><span class="pre">lh.dip</span></code> and &lt;<em>subject</em>&gt;-&lt;<em>spacing</em>&gt;- <code class="docutils literal"><span class="pre">rh.dip</span></code> containing
the source space points in MRIlab compatible ascii format. These
files contain &#8216;dipoles&#8217;, <em>i.e.</em>,
both source space points and cortex normal directions.</li>
<li>If cortical patch statistics is requested, another source
space file called &lt;<em>subject</em>&gt;-&lt;<em>spacing</em>&gt; <code class="docutils literal"><span class="pre">p-src.fif</span></code> will
be created.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&lt;<em>spacing</em>&gt; will    be the suggested source spacing in millimeters if the <code class="docutils literal"><span class="pre">--spacing</span></code> option    is used. For source spaces based on <em>k*th subdivision    of an icosahedron, &lt;*spacing</em>&gt; will    be replaced by <code class="docutils literal"><span class="pre">ico-</span></code> k or <code class="docutils literal"><span class="pre">oct-</span></code> k , respectively.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">After the geometry is set up it is possible to    check that the source space points are located on the cortical surface.    This can be easily done with by loading the <code class="docutils literal"><span class="pre">COR.fif</span></code> file    from <code class="docutils literal"><span class="pre">mri/T1/neuromag/sets</span></code> into MRIlab and by subsequently    overlaying the corresponding pnt or dip files using Import/Strings or Import/Dipoles from    the File menu, respectively.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the SUBJECT environment variable is set correctly    it is usually sufficient to run <code class="docutils literal"><span class="pre">mne_setup_source_space</span></code> without    any options.</p>
</div>
</div>
<div class="section" id="creating-the-bem-model-meshes">
<span id="chdbjcia"></span><h2>Creating the BEM model meshes<a class="headerlink" href="#creating-the-bem-model-meshes" title="Permalink to this headline">¶</a></h2>
<p>Calculation of the forward solution using the boundary-element
model (BEM) requires that the surfaces separating regions of different
electrical conductivities are tessellated with suitable surface
elements. Our BEM software employs triangular tessellations. Therefore,
prerequisites for BEM calculations are the segmentation of the MRI
data and the triangulation of the relevant surfaces.</p>
<p>For MEG computations, a reasonably accurate solution can
be obtained by using a single-compartment BEM assuming the shape
of the intracranial volume. For EEG, the standard model contains
the intracranial space, the skull, and the scalp.</p>
<p>At present, no bulletproof method exists for creating the
triangulations. Feasible approaches are described in <a class="reference internal" href="AppA.html#create-bem-model"><span>Creating the BEM meshes</span></a>.</p>
<div class="section" id="setting-up-the-triangulation-files">
<span id="babdbbfc"></span><h3>Setting up the triangulation files<a class="headerlink" href="#setting-up-the-triangulation-files" title="Permalink to this headline">¶</a></h3>
<p>The segmentation algorithms described in <a class="reference internal" href="AppA.html#create-bem-model"><span>Creating the BEM meshes</span></a> produce
either FreeSurfer surfaces or triangulation
data in text. Before proceeding to the creation of the boundary
element model, standard files (or symbolic links created with the <code class="docutils literal"><span class="pre">ln</span> <span class="pre">-s</span></code> command) have to be present in the subject&#8217;s <code class="docutils literal"><span class="pre">bem</span></code> directory.
If you are employing ASCII triangle files the standard file names
are:</p>
<p><strong>inner_skull.tri</strong></p>
<blockquote>
<div>Contains the inner skull triangulation.</div></blockquote>
<p><strong>outer_skull.tri</strong></p>
<blockquote>
<div>Contains the outer skull triangulation.</div></blockquote>
<p><strong>outer_skin.tri</strong></p>
<blockquote>
<div>Contains the head surface triangulation.</div></blockquote>
<p>The corresponding names for FreeSurfer surfaces
are:</p>
<p><strong>inner_skull.surf</strong></p>
<blockquote>
<div>Contains the inner skull triangulation.</div></blockquote>
<p><strong>outer_skull.surf</strong></p>
<blockquote>
<div>Contains the outer skull triangulation.</div></blockquote>
<p><strong>outer_skin.surf</strong></p>
<blockquote>
<div>Contains the head surface triangulation.</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Different methods can be employed for the creation    of the individual surfaces. For example, it may turn out that the    watershed algorithm produces are better quality skin surface than    the segmentation approach based on the FLASH images. If this is    the case, <code class="docutils literal"><span class="pre">outer_skin.surf</span></code> can set to point to the corresponding    watershed output file while the other surfaces can be picked from    the FLASH segmentation data.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The triangulation files can include name of the    subject as a prefix <code class="docutils literal"><span class="pre">&lt;*subject</span> <span class="pre">name*&gt;-</span></code> , <em>e.g.</em>, <code class="docutils literal"><span class="pre">duck-inner_skull.surf</span></code> .</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The mne_convert_surface utility    described in <a class="reference internal" href="convert.html#behdiajg"><span>Converting surface data between different formats</span></a> can be used to convert text format    triangulation files into the FreeSurfer surface format.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#8220;Aliases&#8221; created with    the Mac OSX finder are not equivalent to symbolic links and do not    work as such for the UNIX shells and MNE programs.</p>
</div>
</div>
</div>
<div class="section" id="setting-up-the-boundary-element-model">
<span id="cihdbfeg"></span><h2>Setting up the boundary-element model<a class="headerlink" href="#setting-up-the-boundary-element-model" title="Permalink to this headline">¶</a></h2>
<p>This stage sets up the subject-dependent data for computing
the forward solutions:</p>
<ul class="simple">
<li>The fif format boundary-element model
geometry file is created. This step also checks that the input surfaces
are complete and that they are topologically correct, <em>i.e.</em>,
that the surfaces do not intersect and that the surfaces are correctly
ordered (outer skull surface inside the scalp and inner skull surface
inside the outer skull). Furthermore, the range of triangle sizes
on each surface is reported. For the three-layer model, the minimum
distance between the surfaces is also computed.</li>
<li>Text files containing the boundary surface vertex coordinates are
created.</li>
<li>The the geometry-dependent BEM solution data are computed. This step
can be optionally omitted. This step takes several minutes to complete.</li>
</ul>
<p>This step assigns the conductivity values to the BEM compartments.
For the scalp and the brain compartments, the default is 0.3 S/m.
The default skull conductivity is 50 times smaller, <em>i.e.</em>,
0.006 S/m. Recent publications, see <a class="reference internal" href="reading.html#cegegdei"><span>Forward modeling</span></a>, report
a range of skull conductivity ratios ranging from 1:15 (Oostendorp <em>et
al.</em>, 2000) to 1:25 - 1:50 (Slew <em>et al.</em>,
2009, Conçalves <em>et al.</em>, 2003). The
MNE default ratio 1:50 is based on the typical values reported in
(Conçalves <em>et al.</em>, 2003), since their
approach is based comparison of SEF/SEP measurements in a BEM model.
The variability across publications may depend on individual variations
but, more importantly, on the precision of the skull compartment
segmentation.</p>
<p>This processing stage is automated with the script mne_setup_forward_model . This
script assumes that:</p>
<ul class="simple">
<li>The anatomical MRI processing has been
completed as described in <a class="reference internal" href="#chdbbcej"><span>Cortical surface reconstruction with FreeSurfer</span></a>.</li>
<li>The BEM model meshes have been created as outlined in <a class="reference internal" href="#chdbjcia"><span>Creating the BEM model meshes</span></a>.</li>
<li>The environment variable SUBJECTS_DIR is set correctly.</li>
</ul>
<p>mne_setup_forward_model accepts
the following options:</p>
<p><strong>&#8212;subject &lt;*subject*&gt;</strong></p>
<blockquote>
<div>Defines the name of the subject. This can be also accomplished
by setting the SUBJECT environment variable.</div></blockquote>
<p><strong>&#8212;surf</strong></p>
<blockquote>
<div>Use the FreeSurfer surface files instead of the default ASCII triangulation
files. Please consult <a class="reference internal" href="#babdbbfc"><span>Setting up the triangulation files</span></a> for the standard file
naming scheme.</div></blockquote>
<p><strong>&#8212;noswap</strong></p>
<blockquote>
<div>Traditionally, the vertices of the triangles in &#8216;tri&#8217; files
have been ordered so that, seen from the outside of the triangulation,
the vertices are ordered in clockwise fashion. The fif files, however,
employ the more standard convention with the vertices ordered counterclockwise.
Therefore, mne_setup_forward_model by
default reverses the vertex ordering before writing the fif file.
If, for some reason, you have counterclockwise-ordered tri files
available this behavior can be turned off by defining <code class="docutils literal"><span class="pre">--noswap</span></code> .
When the fif file is created, the vertex ordering is checked and
the process is aborted if it is incorrect after taking into account
the state of the swapping. Should this happen, try to run mne_setup_forward_model again including
the <code class="docutils literal"><span class="pre">--noswap</span></code> flag. In particular, if you employ the seglab software
to create the triangulations (see <a class="reference internal" href="AppA.html#create-bem-model"><span>Creating the BEM meshes</span></a>), the <code class="docutils literal"><span class="pre">--noswap</span></code> flag
is required. This option is ignored if <code class="docutils literal"><span class="pre">--surf</span></code> is specified</div></blockquote>
<p><strong>&#8212;ico &lt;*number*&gt;</strong></p>
<blockquote>
<div>This option is relevant (and required) only with the <code class="docutils literal"><span class="pre">--surf</span></code> option and
if the surface files have been produced by the watershed algorithm.
The watershed triangulations are isomorphic with an icosahedron,
which has been recursively subdivided six times to yield 20480 triangles.
However, this number of triangles results in a long computation
time even in a workstation with generous amounts of memory. Therefore,
the triangulations have to be decimated. Specifying <code class="docutils literal"><span class="pre">--ico</span> <span class="pre">4</span></code> yields 5120 triangles per surface while <code class="docutils literal"><span class="pre">--ico</span> <span class="pre">3</span></code> results
in 1280 triangles. The recommended choice is <code class="docutils literal"><span class="pre">--ico</span> <span class="pre">4</span></code> .</div></blockquote>
<p><strong>&#8212;homog</strong></p>
<blockquote>
<div>Use a single compartment model (brain only) instead a three layer one
(scalp, skull, and brain). Only the <code class="docutils literal"><span class="pre">inner_skull.tri</span></code> triangulation
is required. This model is usually sufficient for MEG but invalid
for EEG. If you are employing MEG data only, this option is recommended
because of faster computation times. If this flag is specified,
the options <code class="docutils literal"><span class="pre">--brainc</span></code> , <code class="docutils literal"><span class="pre">--skullc</span></code> , and <code class="docutils literal"><span class="pre">--scalpc</span></code> are irrelevant.</div></blockquote>
<p><strong>&#8212;brainc &lt;*conductivity/ S/m*&gt;</strong></p>
<blockquote>
<div>Defines the brain compartment conductivity. The default value is 0.3 S/m.</div></blockquote>
<p><strong>&#8212;skullc &lt;*conductivity/ S/m*&gt;</strong></p>
<blockquote>
<div>Defines the skull compartment conductivity. The default value is 0.006 S/m
corresponding to a conductivity ratio 1/50 between the brain and
skull compartments.</div></blockquote>
<p><strong>&#8212;scalpc &lt;*conductivity/ S/m*&gt;</strong></p>
<blockquote>
<div>Defines the brain compartment conductivity. The default value is 0.3 S/m.</div></blockquote>
<p><strong>&#8212;innershift &lt;*value/mm*&gt;</strong></p>
<blockquote>
<div>Shift the inner skull surface outwards along the vertex normal directions
by this amount.</div></blockquote>
<p><strong>&#8212;outershift &lt;*value/mm*&gt;</strong></p>
<blockquote>
<div>Shift the outer skull surface outwards along the vertex normal directions
by this amount.</div></blockquote>
<p><strong>&#8212;scalpshift &lt;*value/mm*&gt;</strong></p>
<blockquote>
<div>Shift the scalp surface outwards along the vertex normal directions by
this amount.</div></blockquote>
<p><strong>&#8212;nosol</strong></p>
<blockquote>
<div>Omit the BEM model geometry dependent data preparation step. This
can be done later by running mne_setup_forward_model without the <code class="docutils literal"><span class="pre">--nosol</span></code> option.</div></blockquote>
<p><strong>&#8212;model &lt;*name*&gt;</strong></p>
<blockquote>
<div>Name for the BEM model geometry file. The model will be created into
the directory bem as &lt;<em>name</em>&gt;- <code class="docutils literal"><span class="pre">bem.fif</span></code> .        If
this option is missing, standard model names will be used (see below).</div></blockquote>
<p>As a result of running the mne_setup_foward_model script, the
following files are created into the <code class="docutils literal"><span class="pre">bem</span></code> directory:</p>
<ul class="simple">
<li>BEM model geometry specifications &lt;<em>subject</em>&gt;-&lt;<em>ntri-scalp</em>&gt;-&lt;<em>ntri-outer_skull</em>&gt;-&lt;<em>ntri-inner_skull</em>&gt;- <code class="docutils literal"><span class="pre">bem.fif</span></code> or &lt;<em>subject</em>&gt;-&lt;<em>ntri-inner_skull</em>&gt; <code class="docutils literal"><span class="pre">-bem.fif</span></code> containing
the BEM geometry in fif format. The latter file is created if <code class="docutils literal"><span class="pre">--homog</span></code>
option is specified. Here, &lt;<em>ntri-xxx</em>&gt; indicates
the number of triangles on the corresponding surface.</li>
<li>&lt;<em>subject</em>&gt;-&lt;<em>surface name</em>&gt;-&lt;<em>ntri</em>&gt; <code class="docutils literal"><span class="pre">.pnt</span></code> files
are created for each of the surfaces present in the BEM model. These
can be loaded to MRIlab to check the location of the surfaces.</li>
<li>&lt;<em>subject</em>&gt;-&lt;<em>surface name</em>&gt;-&lt;<em>ntri</em>&gt; <code class="docutils literal"><span class="pre">.surf</span></code> files
are created for each of the surfaces present in the BEM model. These
can be loaded to tkmedit to check
the location of the surfaces.</li>
<li>The BEM &#8216;solution&#8217; file containing the geometry
dependent solution data will be produced with the same name as the
BEM geometry specifications with the ending <code class="docutils literal"><span class="pre">-bem-sol.fif</span></code> .
These files also contain all the information in the <code class="docutils literal"><span class="pre">-bem.fif</span></code> files.</li>
</ul>
<p>After the BEM is set up it is advisable to check that the
BEM model meshes are correctly positioned. This can be easily done
with by loading the COR.fif file
from mri/T1-neuromag/sets into
MRIlab and by subsequently overlaying the corresponding pnt files
using Import/Strings from the File menu.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The FreeSurfer format    BEM surfaces can be also viewed with the tkmedit program    which is part of the FreeSurfer distribution.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the SUBJECT environment variable is set, it    is usually sufficient to run <code class="docutils literal"><span class="pre">mne_setup_forward_model</span></code> without    any options for the three-layer model and with the <code class="docutils literal"><span class="pre">--homog</span></code> option    for the single-layer model. If the input files are FreeSurfer surfaces, <code class="docutils literal"><span class="pre">--surf</span></code> and <code class="docutils literal"><span class="pre">--ico</span> <span class="pre">4</span></code> are required as well.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">With help of the <code class="docutils literal"><span class="pre">--nosol</span></code> option    it is possible to create candidate BEM geometry data files quickly    and do the checking with respect to the anatomical MRI data. When    the result is satisfactory, mne_setup_forward_model can be run without <code class="docutils literal"><span class="pre">--nosol</span></code> to    invoke the time-consuming calculation of the solution file as well.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The triangle meshes created by the seglab program    have counterclockwise vertex ordering and thus require the <code class="docutils literal"><span class="pre">--noswap</span></code>    option.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Up to this point all processing stages depend    on the anatomical (geometrical) information only and thus remain    identical across different MEG studies.</p>
</div>
</div>
<div class="section" id="setting-up-the-meg-eeg-analysis-directory">
<h2>Setting up the MEG/EEG analysis directory<a class="headerlink" href="#setting-up-the-meg-eeg-analysis-directory" title="Permalink to this headline">¶</a></h2>
<p>The remaining steps require that the actual MEG/EEG data
are available. It is recommended that a new directory is created
for the MEG/EEG data processing. The raw data files collected should not be
copied there but rather referred to with symbolic links created
with the <code class="docutils literal"><span class="pre">ln</span> <span class="pre">-s</span></code> command. Averages calculated
on-line can be either copied or referred to with links.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you don&#8217;t know how to create a directory,    how to make symbolic links, or how to copy files from the shell    command line, this is a perfect time to learn about this basic skills    from other users or from a suitable elementary book before proceeding.</p>
</div>
</div>
<div class="section" id="preprocessing-the-raw-data">
<h2>Preprocessing the raw data<a class="headerlink" href="#preprocessing-the-raw-data" title="Permalink to this headline">¶</a></h2>
<p>The following MEG and EEG data preprocessing steps are recommended:</p>
<ul class="simple">
<li>The coding problems on the trigger channel
STI 014 may have to fixed, see <a class="reference internal" href="#babcdbdi"><span>Cleaning the digital trigger channel</span></a>.</li>
<li>EEG electrode location information and MEG coil types may
need to be fixed, see <a class="reference internal" href="#babcdfjh"><span>Fixing channel information</span></a>.</li>
<li>The data may be optionally downsampled to facilitate subsequent
processing, see <a class="reference internal" href="#babdgffg"><span>Downsampling the MEG/EEG data</span></a>.</li>
<li>Bad channels in the MEG and EEG data must be identified, see <a class="reference internal" href="#babbhcfg"><span>Designating bad channels</span></a>.</li>
<li>The data has to be filtered to the desired passband. If mne_browse_raw or mne_process_raw is
employed to calculate the offline averages and covariance matrices,
this step is unnecessary since the data are filtered on the fly.
For information on these programs, please consult <a class="reference internal" href="browse.html#ch-browse"><span>Processing raw data</span></a>.</li>
<li>For evoked-response analysis, the data has to be re-averaged
off line, see <a class="reference internal" href="#babeaedf"><span>Off-line averaging</span></a>.</li>
</ul>
<div class="section" id="cleaning-the-digital-trigger-channel">
<span id="babcdbdi"></span><h3>Cleaning the digital trigger channel<a class="headerlink" href="#cleaning-the-digital-trigger-channel" title="Permalink to this headline">¶</a></h3>
<p>The calibration factor of the digital trigger channel used
to be set to a value much smaller than one by the Neuromag data
acquisition software. Especially to facilitate viewing of raw data
in graph it is advisable to change the calibration factor to one.
Furthermore, the eighth bit of the trigger word is coded incorrectly
in the original raw files. Both problems can be corrected by saying:</p>
<p><code class="docutils literal"><span class="pre">mne_fix_stim14</span></code> &lt;<em>raw file</em>&gt;</p>
<p>More information about mne_fix_stim14 is
available in <a class="reference internal" href="utilities.html#chdbfdic"><span>Fixing the encoding of the trigger channel: mne_fix_stim14</span></a>. It is recommended that this
fix is included as the first raw data processing step. Note, however,
the mne_browse_raw and mne_process_raw always sets
the calibration factor to one internally.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If your data file was acquired on or after November 10, 2005 on the Martinos center Vectorview system, it is not necessary to use mne_fix_stim14 .</p>
</div>
</div>
<div class="section" id="fixing-channel-information">
<span id="babcdfjh"></span><h3>Fixing channel information<a class="headerlink" href="#fixing-channel-information" title="Permalink to this headline">¶</a></h3>
<p>There are two potential discrepancies in the channel information
which need to be fixed before proceeding:</p>
<ul class="simple">
<li>EEG electrode locations may be incorrect
if more than 60 EEG channels are acquired.</li>
<li>The magnetometer coil identifiers are not always correct.</li>
</ul>
<p>These potential problems can be fixed with the utilities mne_check_eeg_locations and mne_fix_mag_coil_types,
see <a class="reference internal" href="utilities.html#chdjgggc"><span>Updating EEG location info: mne_check_eeg_locations</span></a> and <a class="reference internal" href="utilities.html#chdgaajc"><span>Updating magnetometer coil types: mne_fix_mag_coil_types</span></a>.</p>
</div>
<div class="section" id="designating-bad-channels">
<span id="babbhcfg"></span><h3>Designating bad channels<a class="headerlink" href="#designating-bad-channels" title="Permalink to this headline">¶</a></h3>
<p>Sometimes some MEG or EEG channels are not functioning properly
for various reasons. These channels should be excluded from the
analysis by marking them bad using the mne_mark_bad_channels utility,
see <a class="reference internal" href="utilities.html#chddhbee"><span>Designating bad channels: mne_mark_bad_channels</span></a>. Especially if a channel does not show
a signal at all (flat) it is most important to exclude it from the
analysis, since its noise estimate will be unrealistically low and
thus the current estimate calculations will give a strong weight
to the zero signal on the flat channels and will essentially vanish.
It is also important to exclude noisy channels because they can
possibly affect others when signal-space projections or EEG average electrode
reference is employed. Noisy bad channels can also adversely affect
off-line averaging and noise-covariance matrix estimation by causing
unnecessary rejections of epochs.</p>
<p>Recommended ways to identify bad channels are:</p>
<ul class="simple">
<li>Observe the quality of data during data
acquisition and make notes of observed malfunctioning channels to
your measurement protocol sheet.</li>
<li>View the on-line averages and check the condition of the channels.</li>
<li>Compute preliminary off-line averages with artefact rejection,
signal-space projection, and EEG average electrode reference computation
off and check the condition of the channels.</li>
<li>View raw data in mne_process_raw or
the Neuromag signal processor graph without
signal-space projection or EEG average electrode reference computation
and identify bad channels.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is strongly recommended that bad channels    are identified and marked in the original raw data files. If present    in the raw data files, the bad channel selections will be automatically    transferred to averaged files, noise-covariance matrices, forward    solution files, and inverse operator decompositions.</p>
</div>
</div>
<div class="section" id="downsampling-the-meg-eeg-data">
<span id="babdgffg"></span><h3>Downsampling the MEG/EEG data<a class="headerlink" href="#downsampling-the-meg-eeg-data" title="Permalink to this headline">¶</a></h3>
<p>The minimum practical sampling frequency of the Vectorview
system is 600 Hz. Lower sampling frequencies are allowed but result
in elevated noise level in the data. It is advisable to lowpass
filter and downsample the large raw data files often emerging in
cognitive and patient studies to speed up subsequent processing.
This can be accomplished with the mne_process_raw and mne_browse_raw software
modules. For details, see <a class="reference internal" href="browse.html#cacfaaaj"><span>Batch-mode options</span></a> and <a class="reference internal" href="browse.html#cacbddie"><span>Save</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is recommended that the original raw file    is called &lt;<em>name</em>&gt;_raw.fif and    the downsampled version &lt;<em>name</em>&gt;_ds_raw.fif ,    respectively.</p>
</div>
</div>
<div class="section" id="off-line-averaging">
<span id="babeaedf"></span><h3>Off-line averaging<a class="headerlink" href="#off-line-averaging" title="Permalink to this headline">¶</a></h3>
<p>The recommended tools for off-line averaging are mne_browse_raw and mne_process_raw . mne_browse_raw is
an interactive program for averaging and noise-covariance matrix
computation. It also includes routines for filtering so that the
downsampling and filtering steps can be skipped. Therefore, with mne_browse_raw you
can produce the off-line average and noise-covariance matrix estimates
directly. The batch-mode version of mne_browse_raw is
called mne_process_raw . Detailed
information on mne_browse_raw and mne_process_raw can
be found in <a class="reference internal" href="browse.html#ch-browse"><span>Processing raw data</span></a>.</p>
</div>
</div>
<div class="section" id="aligning-the-coordinate-frames">
<span id="chdbehdc"></span><h2>Aligning the coordinate frames<a class="headerlink" href="#aligning-the-coordinate-frames" title="Permalink to this headline">¶</a></h2>
<p>The calculation of the forward solution requires knowledge
of the relative location and orientation of the MEG/EEG and MRI
coordinate systems. The MEG/EEG head coordinate system is defined
in <a class="reference internal" href="forward.html#bjebibai"><span>The head and device coordinate systems</span></a>. The conversion tools included in the MNE
software take care of the idiosyncrasies of the coordinate frame
definitions in different MEG and EEG systems so that the fif files
always employ the same definition of the head coordinate system.</p>
<p>Ideally, the head coordinate frame has a fixed orientation
and origin with respect to the head anatomy. Therefore, a single
MRI-head coordinate transformation for each subject should be sufficient.
However, as explained in <a class="reference internal" href="forward.html#bjebibai"><span>The head and device coordinate systems</span></a>, the head coordinate
frame is defined by identifying the fiducial landmark locations,
making the origin and orientation of the head coordinate system
slightly user dependent. As a result, the most conservative choice
for the definition of the coordinate transformation computation
is to re-establish it for each experimental session, <em>i.e.</em>,
each time when new head digitization data are employed.</p>
<p>The interactive source analysis software mne_analyze provides
tools for coordinate frame alignment, see <a class="reference internal" href="analyze.html#ch-interactive-analysis"><span>Interactive analysis</span></a>. <a class="reference internal" href="sampledata.html#chdijbig"><span>MEG-MRI coordinate system alignment</span></a> also
contains tips for using mne_analyze for
this purpose.</p>
<p>Another useful tool for the coordinate system alignment is MRIlab ,
the Neuromag MEG-MRI integration tool. Section 3.3.1 of the MRIlab User&#8217;s
Guide, Neuromag P/N NM20419A-A contains a detailed description of
this task. Employ the images in the set <code class="docutils literal"><span class="pre">mri/T1-neuromag/sets/COR.fif</span></code> for
the alignment. Check the alignment carefully using the digitization
data included in the measurement file as described in Section 5.3.1
of the above manual. Save the aligned description file in the same
directory as the original description file without the alignment
information but under a different name.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This step is extremely important. If    the alignment of the coordinate frames is inaccurate all subsequent    processing steps suffer from the error. Therefore, this step should    be performed by the person in charge of the study or by a trained    technician. Written or photographic documentation of the alignment    points employed during the MEG/EEG acquisition can also be helpful.</p>
</div>
</div>
<div class="section" id="computing-the-forward-solution">
<span id="babchejd"></span><h2>Computing the forward solution<a class="headerlink" href="#computing-the-forward-solution" title="Permalink to this headline">¶</a></h2>
<p>After the MRI-MEG/EEG alignment has been set, the forward
solution, <em>i.e.</em>, the magnetic fields and electric
potentials at the measurement sensors and electrodes due to dipole
sources located on the cortex, can be calculated with help of the
convenience script mne_do_forward_solution .
This utility accepts the following options:</p>
<p><strong>&#8212;subject &lt;*subject*&gt;</strong></p>
<blockquote>
<div>Defines the name of the subject. This can be also accomplished
by setting the SUBJECT environment variable.</div></blockquote>
<p><strong>&#8212;src &lt;*name*&gt;</strong></p>
<blockquote>
<div>Source space name to use. This option overrides the <code class="docutils literal"><span class="pre">--spacing</span></code> option. The
source space is searched first from the current working directory
and then from <code class="docutils literal"><span class="pre">$SUBJECTS_DIR/</span></code> &lt;<em>subject</em>&gt; /bem.
The source space file must be specified exactly, including the <code class="docutils literal"><span class="pre">fif</span></code> extension.</div></blockquote>
<p><strong>&#8212;spacing &lt;*spacing/mm*&gt;  or ``ico-`` &lt;*number  or ``oct-`` &lt;*number*&gt;</strong></p>
<blockquote>
<div>This is an alternate way to specify the name of the source space
file. For example, if <code class="docutils literal"><span class="pre">--spacing</span> <span class="pre">6</span></code> is given on the command
line, the source space files searched for are./&lt;<em>subject</em>&gt; -6-src.fif
and <code class="docutils literal"><span class="pre">$SUBJECTS_DIR/$SUBJECT/</span></code> bem/&lt;<em>subject</em>&gt; -6-src.fif.
The first file found is used. Spacing defaults to 7 mm.</div></blockquote>
<p><strong>&#8212;bem &lt;*name*&gt;</strong></p>
<blockquote>
<div>Specifies the BEM to be used. The name of the file can be any of &lt;<em>name</em>&gt; , &lt;<em>name</em>&gt; -bem.fif, &lt;<em>name</em>&gt; -bem-sol.fif.
The file is searched for from the current working directory and
from <code class="docutils literal"><span class="pre">bem</span></code> . If this option is omitted, the most recent
BEM file in the <code class="docutils literal"><span class="pre">bem</span></code> directory is used.</div></blockquote>
<p><strong>&#8212;mri &lt;*name*&gt;</strong></p>
<blockquote>
<div>The name of the MRI description file containing the MEG/MRI coordinate
transformation. This file was saved as part of the alignment procedure
outlined in <a class="reference internal" href="#chdbehdc"><span>Aligning the coordinate frames</span></a>. The file is searched for from
the current working directory and from <code class="docutils literal"><span class="pre">mri/T1-neuromag/sets</span></code> .
The search order for MEG/MRI coordinate transformations is discussed
below.</div></blockquote>
<p><strong>&#8212;trans      &lt;*name*&gt;</strong></p>
<blockquote>
<div>The name of a text file containing the 4 x 4 matrix for the coordinate transformation
from head to mri coordinates, see below. If the option <code class="docutils literal"><span class="pre">--trans</span></code> is
present, the <code class="docutils literal"><span class="pre">--mri</span></code> option is not required. The search
order for MEG/MRI coordinate transformations is discussed below.</div></blockquote>
<p><strong>&#8212;meas &lt;*name*&gt;</strong></p>
<blockquote>
<div>This file is the measurement fif file or an off-line average file
produced thereof. It is recommended that the average file is employed for
evoked-response data and the original raw data file otherwise. This
file provides the MEG sensor locations and orientations as well as
EEG electrode locations as well as the coordinate transformation between
the MEG device coordinates and MEG head-based coordinates.</div></blockquote>
<p><strong>&#8212;fwd &lt;*name*&gt;</strong></p>
<blockquote>
<div>This file will contain the forward solution as well as the coordinate transformations,
sensor and electrode location information, and the source space
data. A name of the form &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-fwd.fif</span></code> is
recommended. If this option is omitted the forward solution file
name is automatically created from the measurement file name and
the source space name.</div></blockquote>
<p><strong>&#8212;destdir &lt;*directory*&gt;</strong></p>
<blockquote>
<div>Optionally specifies a directory where the forward solution will
be stored.</div></blockquote>
<p><strong>&#8212;mindist &lt;*dist/mm*&gt;</strong></p>
<blockquote>
<div>Omit source space points closer than this value to the inner skull surface.
Any source space points outside the inner skull surface are automatically
omitted. The use of this option ensures that numerical inaccuracies
for very superficial sources do not cause unexpected effects in
the final current estimates. Suitable value for this parameter is
of the order of the size of the triangles on the inner skull surface.
If you employ the seglab software
to create the triangulations, this value should be about equal to
the wish for the side length of the triangles.</div></blockquote>
<p><strong>&#8212;megonly</strong></p>
<blockquote>
<div>Omit EEG forward calculations.</div></blockquote>
<p><strong>&#8212;eegonly</strong></p>
<blockquote>
<div>Omit MEG forward calculations.</div></blockquote>
<p><strong>&#8212;all</strong></p>
<blockquote>
<div>Compute the forward solution for all vertices on the source space.</div></blockquote>
<p><strong>&#8212;overwrite</strong></p>
<blockquote>
<div>Overwrite the possibly existing forward model file.</div></blockquote>
<p><strong>&#8212;help</strong></p>
<blockquote>
<div>Show usage information for the script.</div></blockquote>
<p>The MEG/MRI transformation is determined by the following
search sequence:</p>
<ul class="simple">
<li>If the <code class="docutils literal"><span class="pre">--mri</span></code> option was
present, the file is looked for literally as specified, in the directory
of the measurement file specified with the <code class="docutils literal"><span class="pre">--meas</span></code> option,
and in the directory $SUBJECTS_DIR/$SUBJECT/mri/T1-neuromag/sets.
If the file is not found, the script exits with an error message.</li>
<li>If the <code class="docutils literal"><span class="pre">--trans</span></code> option was present, the file is
looked up literally as specified. If the file is not found, the
script exists with an error message.</li>
<li>If neither <code class="docutils literal"><span class="pre">--mri</span></code> nor <code class="docutils literal"><span class="pre">--trans</span></code> option
was not present, the following default search sequence is engaged:<ul>
<li>The <code class="docutils literal"><span class="pre">.fif</span></code> ending in the
measurement file name is replaced by <code class="docutils literal"><span class="pre">-trans.fif</span></code> . If
this file is present, it will be used.</li>
<li>The newest file whose name ends with <code class="docutils literal"><span class="pre">-trans.fif</span></code> in
the directory of the measurement file is looked up. If such a file
is present, it will be used.</li>
<li>The newest file whose name starts with <code class="docutils literal"><span class="pre">COR-</span></code> in
directory $SUBJECTS_DIR/$SUBJECT/mri/T1-neuromag/sets is looked
up. If such a file is present, it will be used.</li>
<li>If all the above searches fail, the script exits with an error
message.</li>
</ul>
</li>
</ul>
<p>This search sequence is designed to work well with the MEG/MRI
transformation files output by mne_analyze ,
see <a class="reference internal" href="analyze.html#cacehgcd"><span>Coordinate frame alignment</span></a>. It is recommended that -trans.fif file
saved with the Save default and Save... options in
the mne_analyze alignment dialog
are used because then the $SUBJECTS_DIR/$SUBJECT directory will
be composed of files which are dependent on the subjects&#8217;s
anatomy only, not on the MEG/EEG data to be analyzed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the standard MRI description file and BEM    file selections are appropriate and the 7-mm source space grid spacing    is appropriate, only the <code class="docutils literal"><span class="pre">--meas</span></code> option is necessary.    If EEG data is not used <code class="docutils literal"><span class="pre">--megonly</span></code> option should be    included.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If it is conceivable that the current-density    transformation will be incorporated into the inverse operator, specify    a source space with patch information for the forward computation.    This is not mandatory but saves a lot of time when the inverse operator    is created, since the patch information does not need to be created    at that stage.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The MEG head to MRI transformation matrix specified    with the <code class="docutils literal"><span class="pre">--trans</span></code> option should be a text file containing    a 4-by-4 matrix:</p>
</div>
<div class="math">
<p><span class="math">T = \begin{bmatrix}
R_{11} &amp; R_{12} &amp; R_{13} &amp; x_0 \\
R_{13} &amp; R_{13} &amp; R_{13} &amp; y_0 \\
R_{13} &amp; R_{13} &amp; R_{13} &amp; z_0 \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}</span></p>
</div><p>defined so that if the augmented location vectors in MRI
head and MRI coordinate systems are denoted by <span class="math">r_{head}[x_{head}\ y_{head}\ z_{head}\ 1]</span> and <span class="math">r_{MRI}[x_{MRI}\ y_{MRI}\ z_{MRI}\ 1]</span>,
respectively,</p>
<div class="math">
<p><span class="math">r_{MRI} = T r_{head}</span></p>
</div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not possible to calculate an EEG forward    solution with a single-layer BEM.</p>
</div>
</div>
<div class="section" id="setting-up-the-noise-covariance-matrix">
<span id="babdeeeb"></span><h2>Setting up the noise-covariance matrix<a class="headerlink" href="#setting-up-the-noise-covariance-matrix" title="Permalink to this headline">¶</a></h2>
<p>The MNE software employs an estimate of the noise-covariance
matrix to weight the channels correctly in the calculations. The
noise-covariance matrix provides information about field and potential
patterns representing uninteresting noise sources of either human
or environmental origin.</p>
<p>The noise covariance matrix can be calculated in several
ways:</p>
<ul class="simple">
<li>Employ the individual epochs during
off-line averaging to calculate the full noise covariance matrix.
This is the recommended approach for evoked responses.</li>
<li>Employ empty room data (collected without the subject) to
calculate the full noise covariance matrix. This is recommended
for analyzing ongoing spontaneous activity.</li>
<li>Employ a section of continuous raw data collected in the presence
of the subject to calculate the full noise covariance matrix. This
is the recommended approach for analyzing epileptic activity. The
data used for this purpose should be free of technical artifacts
and epileptic activity of interest. The length of the data segment
employed should be at least 20 seconds. One can also use a long
(<cite>*&gt; 200 s</cite>) segment of data with epileptic spikes present provided
that the spikes occur infrequently and that the segment is apparently
stationary with respect to background brain activity.</li>
</ul>
<p>The new raw data processing tools, mne_browse_raw or mne_process_raw include
computation of noise-covariance matrices both from raw data and
from individual epochs. For details, see <a class="reference internal" href="browse.html#ch-browse"><span>Processing raw data</span></a>.</p>
</div>
<div class="section" id="calculating-the-inverse-operator-decomposition">
<span id="cihcfjei"></span><h2>Calculating the inverse operator decomposition<a class="headerlink" href="#calculating-the-inverse-operator-decomposition" title="Permalink to this headline">¶</a></h2>
<p>The MNE software doesn&#8217;t calculate the inverse operator
explicitly but rather computes an SVD of a matrix composed of the
noise-covariance matrix, the result of the forward calculation,
and the source covariance matrix. This approach has the benefit
that the regularization parameter (&#8216;SNR&#8217;) can
be adjusted easily when the final source estimates or dSPMs are
computed. For mathematical details of this approach, please consult <a class="reference internal" href="mne.html#cbbdjfbj"><span>Minimum-norm estimates</span></a>.</p>
<p>This computation stage is facilitated by the convenience
script mne_do_inverse_operator . It
invokes the program mne_inverse_operator with
appropriate options, derived from the command line of mne_do_inverse_operator .</p>
<p>mne_do_inverse_operator assumes
the following options:</p>
<p><strong>&#8212;fwd &lt;*name of the forward solution file*&gt;</strong></p>
<blockquote>
<div>This is the forward solution file produced in the computations step described
in <a class="reference internal" href="#babchejd"><span>Computing the forward solution</span></a>.</div></blockquote>
<p><strong>&#8212;meg</strong></p>
<blockquote>
<div>Employ MEG data in the inverse calculation. If neither <code class="docutils literal"><span class="pre">--meg</span></code> nor <code class="docutils literal"><span class="pre">--eeg</span></code> is
set only MEG channels are included.</div></blockquote>
<p><strong>&#8212;eeg</strong></p>
<blockquote>
<div>Employ EEG data in the inverse calculation. If neither <code class="docutils literal"><span class="pre">--meg</span></code> nor <code class="docutils literal"><span class="pre">--eeg</span></code> is
set only MEG channels are included.</div></blockquote>
<p><strong>&#8212;fixed</strong></p>
<blockquote>
<div>Use fixed source orientations normal to the cortical mantle. By default,
the source orientations are not constrained. If <code class="docutils literal"><span class="pre">--fixed</span></code> is specified,
the <code class="docutils literal"><span class="pre">--loose</span></code> flag is ignored.</div></blockquote>
<p><strong>&#8212;loose &lt;*amount*&gt;</strong></p>
<blockquote>
<div>Use a &#8216;loose&#8217; orientation constraint. This means
that the source covariance matrix entries corresponding to the current
component normal to the cortex are set equal to one and the transverse
components are set to &lt;<em>amount</em>&gt; .
Recommended value of amount is 0.1...0.6.</div></blockquote>
<p><strong>&#8212;depth</strong></p>
<blockquote>
<div>Employ depth weighting with the standard settings. For details,
see <a class="reference internal" href="mne.html#cbbdfjie"><span>Depth weighting</span></a> and <a class="reference internal" href="mne.html#cbbddbgf"><span>Inverse-operator decomposition</span></a>.</div></blockquote>
<p><strong>&#8212;bad &lt;*name*&gt;</strong></p>
<blockquote>
<div>Specifies a text file to designate bad channels, listed one channel name
(like MEG 1933) on each line of the file. Be sure to include both
noisy and flat (non-functioning) channels in the list. If bad channels
were designated using mne_mark_bad_channels in
the measurement file which was specified with the <code class="docutils literal"><span class="pre">--meas</span></code> option when
the forward solution was computed, the bad channel information will
be automatically included. Also, any bad channel information in
the noise-covariance matrix file will be included.</div></blockquote>
<p><strong>&#8212;noisecov &lt;*name*&gt;</strong></p>
<blockquote>
<div>Name of the noise-covariance matrix file computed with one of the methods
described in <a class="reference internal" href="#babdeeeb"><span>Setting up the noise-covariance matrix</span></a>. By default, the script looks
for a file whose name is derived from the forward solution file
by replacing its ending <code class="docutils literal"><span class="pre">-</span></code> &lt;<em>anything</em>&gt; <code class="docutils literal"><span class="pre">-fwd.fif</span></code> by <code class="docutils literal"><span class="pre">-cov.fif</span></code> .
If this file contains a projection operator, which will automatically
attached to the noise-covariance matrix by mne_browse_raw and mne_process_raw ,
no <code class="docutils literal"><span class="pre">--proj</span></code> option is necessary because mne_inverse_operator will
automatically include the projectors from the noise-covariance matrix
file. For backward compatibility, &#8211;senscov can be used as a synonym
for &#8211;noisecov.</div></blockquote>
<p><strong>&#8212;noiserank &lt;*value*&gt;</strong></p>
<blockquote>
<div>Specifies the rank of the noise covariance matrix explicitly rather than
trying to reduce it automatically. This option is sheldom needed,</div></blockquote>
<p><strong>&#8212;megreg &lt;*value*&gt;</strong></p>
<blockquote>
<div>Regularize the MEG part of the noise-covariance matrix by this amount.
Suitable values are in the range 0.05...0.2. For details, see <a class="reference internal" href="mne.html#cbbhegab"><span>Regularization of the noise-covariance matrix</span></a>.</div></blockquote>
<p><strong>&#8212;eegreg &lt;*value*&gt;</strong></p>
<blockquote>
<div>Like <code class="docutils literal"><span class="pre">--megreg</span></code> but applies to the EEG channels.</div></blockquote>
<p><strong>&#8212;diagnoise</strong></p>
<blockquote>
<div>Omit the off-diagonal terms of the noise covariance matrix. This option
is irrelevant to most users.</div></blockquote>
<p><strong>&#8212;fmri &lt;*name*&gt;</strong></p>
<blockquote>
<div>With help of this w file, an <em>a priori</em> weighting
can be applied to the source covariance matrix. The source of the weighting
is usually fMRI but may be also some other data, provided that the weighting can
be expressed as a scalar value on the cortical surface, stored in
a w file. It is recommended that this w file is appropriately smoothed (see <a class="reference internal" href="morph.html#chdebahh"><span>About smoothing</span></a>)
in mne_analyze , tksurfer or
with mne_smooth_w to contain
nonzero values at all vertices of the triangular tessellation of
the cortical surface. The name of the file given is used as a stem of
the w files. The actual files should be called &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-lh.pri</span></code> and &lt;<em>name</em>&gt; <code class="docutils literal"><span class="pre">-rh.pri</span></code> for
the left and right hemisphere weight files, respectively. The application
of the weighting is discussed in <a class="reference internal" href="mne.html#cbbdijhi"><span>fMRI-guided estimates</span></a>.</div></blockquote>
<p><strong>&#8212;fmrithresh &lt;*value*&gt;</strong></p>
<blockquote>
<div>This option is mandatory and has an effect only if a weighting function
has been specified with the <code class="docutils literal"><span class="pre">--fmri</span></code> option. If the value
is in the <em>a priori</em> files falls below this value
at a particular source space point, the source covariance matrix
values are multiplied by the value specified with the <code class="docutils literal"><span class="pre">--fmrioff</span></code> option
(default 0.1). Otherwise it is left unchanged.</div></blockquote>
<p><strong>&#8212;fmrioff &lt;*value*&gt;</strong></p>
<blockquote>
<div>The value by which the source covariance elements are multiplied
if the <em>a priori</em> weight falls below the threshold
set with <code class="docutils literal"><span class="pre">--fmrithresh</span></code> , see above.</div></blockquote>
<p><strong>&#8212;srccov &lt;*name*&gt;</strong></p>
<blockquote>
<div>Use this diagonal source covariance matrix. By default the source covariance
matrix is a multiple of the identity matrix. This option is irrelevant
to most users.</div></blockquote>
<p><strong>&#8212;proj &lt;*name*&gt;</strong></p>
<blockquote>
<div>Include signal-space projection information from this file.</div></blockquote>
<p><strong>&#8212;inv &lt;*name*&gt;</strong></p>
<blockquote>
<div>Save the inverse operator decomposition here. By default, the script looks
for a file whose name is derived from the forward solution file by
replacing its ending <code class="docutils literal"><span class="pre">-fwd.fif</span></code> by &lt;<em>options</em>&gt; <code class="docutils literal"><span class="pre">-inv.fif</span></code> , where
&lt;<em>options</em>&gt; includes options <code class="docutils literal"><span class="pre">--meg</span></code>, <code class="docutils literal"><span class="pre">--eeg</span></code>, and <code class="docutils literal"><span class="pre">--fixed</span></code> with the double
dashes replaced by single ones.</div></blockquote>
<p><strong>&#8212;destdir &lt;*directory*&gt;</strong></p>
<blockquote>
<div>Optionally specifies a directory where the inverse operator will
be stored.</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If bad channels are included in the calculation,    strange results may ensue. Therefore, it is recommended that the    data to be analyzed is carefully inspected with to assign the bad    channels correctly.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For convenience, the MNE software includes bad-channel    designation files which can be used to ignore all magnetometer or    all gradiometer channels in Vectorview measurements. These files are    called <code class="docutils literal"><span class="pre">vv_grad_only.bad</span></code> and <code class="docutils literal"><span class="pre">vv_mag_only.bad</span></code> , respectively.    Both files are located in <code class="docutils literal"><span class="pre">$MNE_ROOT/share/mne/templates</span></code> .</p>
</div>
</div>
<div class="section" id="analyzing-the-data">
<h2>Analyzing the data<a class="headerlink" href="#analyzing-the-data" title="Permalink to this headline">¶</a></h2>
<p>Once all the preprocessing steps described above have been
completed, the inverse operator computed can be applied to the MEG
and EEG data and the results can be viewed and stored in several
ways:</p>
<ul class="simple">
<li>The interactive analysis tool mne_analyze can
be used to explore the data and to produce quantitative analysis
results, screen snapshots, and QuickTime (TM) movie files.
For comprehensive information on mne_analyze ,
please consult <a class="reference internal" href="analyze.html#ch-interactive-analysis"><span>Interactive analysis</span></a>.</li>
<li>The command-line tool mne_make_movie can
be invoked to produce QuickTime movies and snapshots. mne_make_movie can
also output the data in the stc (movies) and w (snapshots) formats
for subsequent processing. Furthermore, subject-to-subject morphing
is included in mne_make_movie to
facilitate cross-subject averaging and comparison of data among
subjects. mne_make_movie is described
in <a class="reference internal" href="mne.html#cbbecede"><span>Producing movies and snapshots</span></a>.</li>
<li>The command-line tool mne_make_movie can
be employed to interrogate the source estimate waveforms from labels
(ROIs).</li>
<li>The mne_make_movie tool
can be also used to create movies from stc files and to resample
stc files in time.</li>
<li>The mne_compute_raw_inverse tool
can be used to produce fif files containing source estimates at
selected ROIs. The input data file can be either a raw data or evoked
response MEG/EEG file, see <a class="reference internal" href="mne.html#cbbcghah"><span>Computing inverse from raw and evoked data</span></a>.</li>
<li>Using the MNE Matlab toolbox, it is possible to perform many
of the above operations in Matlab using your own Matlab code based
on the MNE Matlab toolbox. For more information on the MNE Matlab
toolbox, see <a class="reference internal" href="matlab.html#ch-matlab"><span>The Matlab toolbox</span></a>.</li>
<li>It is also possible to average the source estimates across
subjects as described in <a class="reference internal" href="morph.html#ch-morph"><span>Morphing and averaging</span></a>.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012-2015, MNE Developers.
      Last updated on May 22, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4a0+.
    </div>
  </body>
</html>